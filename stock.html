<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    let allItems = [];

    async function loadStock() {
      const res = await fetch('/get-stock');
      const stockItems = await res.json();
      allItems = stockItems;

      const list = document.getElementById('stockList');
      const updateDropdown = document.getElementById('updateItem');
      list.innerHTML = '';
      updateDropdown.innerHTML = '<option value="">--Select Item--</option>';

      let lowStockItems = [];

      stockItems.forEach(item => {
        const lowStock = item.currentQuantity == 1;
        if (lowStock) lowStockItems.push(item.item);

        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-start";
        li.innerHTML = `
          <div>
            <div class="fw-bold">${item.item} (${item.stockType})</div>
            ‚Çπ${item.price}/kg | Purchased: ${item.purchaseDate}<br>
            Total: ${item.totalQuantity}kg | Current: ${item.currentQuantity}kg
            ${lowStock ? '<span class="text-danger fw-bold"> ‚ö†Ô∏è Low Stock!</span>' : ''}
          </div>
          <button class="btn btn-sm btn-danger" onclick="deleteStock('${item.item}')">Delete</button>
        `;
        list.appendChild(li);

        updateDropdown.innerHTML += `<option value="${item.item}">${item.item}</option>`;
      });

      if (lowStockItems.length > 0) {
        alert(`‚ö†Ô∏è Warning!\nLow stock detected for: ${lowStockItems.join(", ")}`);
      }
    }

    async function addStock() {
      const item = document.getElementById('stockItem').value.trim();
      let stockType = document.getElementById('stockType').value;
      const customType = document.getElementById('customType').value.trim();
      const price = document.getElementById('stockPrice').value;
      const purchaseDate = document.getElementById('purchaseDate').value;
      const totalQuantity = document.getElementById('totalQuantity').value;

      if (stockType === 'Other' && customType) {
        stockType = customType;
      }

      if (!item || !stockType || !price || !purchaseDate || !totalQuantity) {
        return alert("Please fill all fields.");
      }

      try {
        const res = await fetch('/add-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item,
            stockType,
            price: parseFloat(price),
            purchaseDate,
            totalQuantity: parseInt(totalQuantity),
            currentQuantity: parseInt(totalQuantity)
          })
        });

        if (!res.ok) throw new Error('Failed to add stock');
        alert("Stock added successfully!");
        loadStock();
      } catch (error) {
        console.error(error);
        alert('Error adding stock. Please try again.');
      }

      document.getElementById('stockItem').value = '';
      document.getElementById('stockType').value = '';
      document.getElementById('customType').value = '';
      document.getElementById('stockPrice').value = '';
      document.getElementById('purchaseDate').value = '';
      document.getElementById('totalQuantity').value = '';
      document.getElementById('customType').style.display = 'none';
    }

    async function updateQuantity() {
      const item = document.getElementById('updateItem').value;
      const newQty = parseInt(document.getElementById('newQuantity').value);
      if (!item || isNaN(newQty)) return alert("Select item and enter valid quantity.");

      try {
        const res = await fetch('/update-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item, newQuantity: newQty })
        });

        if (!res.ok) throw new Error('Failed to update stock');

        alert("Stock quantity updated successfully!");
        loadStock();
      } catch (error) {
        console.error(error);
        alert('Error updating stock.');
      }

      document.getElementById('updateItem').value = '';
      document.getElementById('newQuantity').value = '';
    }

    async function deleteStock(item) {
      if (!confirm(`Delete "${item}" from stock?`)) return;

      try {
        const res = await fetch('/delete-stock', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item })
        });

        if (!res.ok) throw new Error('Failed to delete');

        alert('Deleted successfully!');
        loadStock();
      } catch (error) {
        console.error(error);
        alert('Error deleting stock.');
      }
    }

    function toggleInput(selectId, inputId) {
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);
      input.style.display = select.value === 'Other' ? 'block' : 'none';
    }

    window.onload = loadStock;
  </script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="bg-white p-4 rounded shadow-sm">
      <h2 class="mb-4">Manage Stock</h2>

      <h4>Add New Stock</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Item Name</label>
          <input type="text" id="stockItem" class="form-control" placeholder="Enter Item Name">
        </div>
        <div class="col-md-6">
          <label class="form-label">Stock Type</label>
          <select id="stockType" class="form-select" onchange="toggleInput('stockType','customType')">
            <option value="">--Select--</option>
            <option>Fertilizers</option>
            <option>Pesticides</option>
            <option>Seeds</option>
            <option>Animal Feed</option>
            <option>Other</option>
          </select>
          <input type="text" id="customType" class="form-control mt-2" placeholder="Enter Custom Type" style="display:none;">
        </div>
        <div class="col-md-4">
          <label class="form-label">Price (‚Çπ/kg)</label>
          <input type="number" id="stockPrice" class="form-control" min="0" step="0.01">
        </div>
        <div class="col-md-4">
          <label class="form-label">Purchase Date</label>
          <input type="date" id="purchaseDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Total Quantity (kg)</label>
          <input type="number" id="totalQuantity" class="form-control" min="0">
        </div>
      </div>
      <div class="mt-3">
        <button onclick="addStock()" class="btn btn-success me-2">‚ûï Add to Stock</button>
        <a href="dashboard.html" class="btn btn-outline-success">‚¨ÖÔ∏è Go to Dashboard</a>
      </div>

      <hr class="my-4">

      <h4>Update Current Quantity</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Select Item</label>
          <select id="updateItem" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">New Quantity (kg)</label>
          <input type="number" id="newQuantity" class="form-control" min="0">
        </div>
      </div>
      <div class="mt-3">
        <button onclick="updateQuantity()" class="btn btn-success">üîÅ Update Quantity</button>
      </div>

      <hr class="my-4">

      <h4>Current Stock</h4>
      <ul class="list-group" id="stockList"></ul>
    </div>
  </div>
</body>
</html>
