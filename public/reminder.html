<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crop Calendar / Reminders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .calendar-container { display: flex; gap: 20px; padding: 40px; max-width: 1000px; margin: auto; background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .reminder-sidebar { width: 30%; }
    .reminder-list { list-style: none; padding-left: 0; }
    .reminder-item { background: #f1f8f2; border-left: 5px solid #4CAF50; padding: 10px 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
    .btn-add { width: 100%; }
  </style>
</head>
<body>

<h2 class="text-center my-4">ðŸ“… Crop Calendar / Reminders</h2>
<div class="calendar-container">
  <div>
    <div id="calendar"></div>
    <button class="btn btn-success mt-3 btn-add" onclick="addReminder()">Add Reminder</button>
  </div>
  <div class="reminder-sidebar">
    <h5>ðŸ”” Daily Reminders</h5>
    <ul id="reminderList" class="reminder-list"></ul>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Reminder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Date:</strong> <span id="modalDate"></span></p>
        <p id="modalNote"></p>
        <button class="btn btn-primary" onclick="editReminder()">Edit</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const farmer_ID = 21; // or get from session
  const calendarDiv = document.getElementById('calendar');
  let selectedDate = null;
  let selectedReminder = null;

  flatpickr(calendarDiv, {
    inline: true,
    onChange: function (selectedDates, dateStr) {
      selectedDate = dateStr;
      loadReminders(dateStr);
    }
  });

  function loadReminders(dateStr) {
    fetch(`http://localhost:3000/get-reminders/${farmer_ID}?date=${dateStr}`)
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById('reminderList');
        list.innerHTML = '';
        if (data.length === 0) {
          list.innerHTML = '<li class="text-muted">No reminders</li>';
        } else {
          data.forEach(r => {
            const li = document.createElement('li');
            li.className = 'reminder-item';
            li.innerHTML = `<strong>${r.title}</strong><br><small>${r.note || ''}</small>`;
            li.onclick = () => showReminderDetail(r);
            list.appendChild(li);
          });
        }
      });
  }

  function showReminderDetail(reminder) {
    selectedReminder = reminder;
    document.getElementById('modalTitle').textContent = reminder.title;
    document.getElementById('modalDate').textContent = reminder.reminder_date;
    document.getElementById('modalNote').textContent = reminder.note || '(No details)';
    new bootstrap.Modal(document.getElementById('reminderModal')).show();
  }

  function editReminder() {
    const newTitle = prompt("Edit Title", selectedReminder.title);
    if (!newTitle) return;
    const newNote = prompt("Edit Note", selectedReminder.note || '');
    fetch(`http://localhost:3000/update-reminder/${selectedReminder.reminder_ID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: newTitle, note: newNote })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('reminderModal')).hide();
        loadReminders(selectedDate);
        alert("Reminder updated");
      }
    });
  }

  function addReminder() {
    if (!selectedDate) return alert('Please select a date on the calendar first.');

    const title = prompt('Enter reminder title (e.g., Sowing, Harvest)');
    if (!title) return;

    const note = prompt('Enter reminder note (optional details)');
    if (note === null) return;

    fetch('http://localhost:3000/add-reminder', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ farmer_ID, title, note, reminder_date: selectedDate })
    })
    .then(res => {
      if (res.ok) {
        loadReminders(selectedDate);
        alert('Reminder added!');
      } else {
        alert('Failed to add reminder');
      }
    });
  }
</script>

</body>
</html>
